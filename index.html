<!DOCTYPE html>
<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <title>Organisation Chart</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" type="text/css"/>
    <link rel="stylesheet" href="assets/css/jquery.jOrgChart.css" type="text/css"/>
    <link rel="stylesheet" href="assets/css/custom.css" type="text/css"/>
    <link rel="stylesheet" href="assets/css/prettify.css" type="text/css"/>

    <script type="text/javascript" src="assets/js/prettify.js"></script>
    
    <!-- jQuery includes -->
    <script type="text/javascript" src="assets/js/jquery.min.js"></script>
    <script type="text/javascript" src="assets/js/jquery-ui.min.js"></script>
    
    <script src="assets/js/jquery.jOrgChart.js"></script>
	<script src="data/merged_data123.js" ></script>
    <script>
    jQuery(document).ready(function() {
        $("#org").jOrgChart({
            chartElement : '#chart',
            dragAndDrop  : true
        });
    });
    </script>
  </head>

  <body onload="prettyPrint();">
    <div class="topbar">
        <div class="topbar-inner">
            <div class="container">
				<a class="brand" href="#"><img alt="logo" src="assets/img/logo.png"></a>
                <a class="brand" href="#">ORGANI<span style="color:white;">GRAMME</span></a>
                <ul class="nav">
                    <li><a href="">Menu1</a></li>
                    <li><a href="">Menu2</a></li>                        
                </ul>
                <div class="pull-right">
                    <div class="alert-message info" id="show-list">Liste</div>
                    
<pre class="prettyprint lang-html" id="list-html" style="display:none"></pre>       
                </div>              
            </div>
        </div>
    </div>
    
	<ul id="org" style="display:none"></ul>
             
    
    <div id="chart" class="orgChart"></div>

    
<script>
	console.log("data = "+data.length);
	var currentYear = new Date().getFullYear();
	var ul = document.getElementById('org');
	var formComp = formatCompare(data[0].prenom+" "+data[0].nom);
	//var lastLi;
	//var display = data[0].nom+" "+data[0].prenom
	//var li = document.createElement('li');
	//ul.appendChild(li);
	
	var li = drawPrsn(data[0],ul,formComp);
	
	//li.innerHTML=li.innerHTML + display;
	//li.dataset.name = data[0].prenom+" "+data[0].nom;
		console.log(li);
		var children = findChildren(li.dataset.name);
		console.log(children);
		drawChildren(li,children);
		console.log("data = "+data.length);

	
	function findChildren(hierarchy) {
		var children = [];
		var indexes = [];
		for(var i in data) {
			if ("hierarchie" in data[i] && data[i].hierarchie != "" && formatCompare(data[i].hierarchie) == hierarchy) {
				children.push(data[i]);
				indexes.push(i);
			}else if("hierarchy_auto" in data[i] && data[i].hierarchy_auto != "" && formatCompare(data[i].hierarchy_auto) == hierarchy) {
				children.push(data[i]);
				indexes.push(i);
			}
		}
		// On supprime les éléments du tableau d'origine afin de ne plus itérer dessus (performances)
		/*if(indexes.length>0){
			for(var i in indexes) {
				data.splice(indexes[i],1);
			}
		}		*/
		return children;
	}
	
	function drawChildren(li,children){
		if (children.length > 0){
			var ulChild = document.createElement('ul');
			li.appendChild(ulChild);
			for(var i in children) {
				var formComp = formatCompare(children[i].prenom+" "+children[i].nom);
				// Si cet élément existe déjà sur la page (garde-fou contre la récursion infinie)
				if ($('[data-name="'+formComp+'"]').length > 0) {
					console.log("GARDE-FOU",children[i]);
					continue;
				}
				var liChild = drawPrsn(children[i],ulChild,formComp);
				var c  = findChildren(formComp);
				drawChildren(liChild,c);
			}
		}
	}
	
	function drawPrsn(prsn,parent,formComp){		
		var liChild = document.createElement('li');
		parent.appendChild(liChild);
		if("annee_naissance" in prsn){
			var age = currentYear-parseInt(prsn.annee_naissance);
			var ageStr = "\n "+age+" ans";
		}else{
			var ageStr = "";
		}
		
		// Données du tootlip
		var civilite = ("civilite" in prsn && prsn.civilite != "")? prsn.civilite : "";
		var anciennete = ("anciennete" in prsn && prsn.anciennete != "")? "\n Ancienneté : "+prsn.anciennete : "";
		var categorie_pro = ("categorie_pro" in prsn && prsn.categorie_pro != "")? "\n Catégorie : "+prsn.categorie_pro : "";
		var id = ("id" in prsn && prsn.id != "")? "\n Id : "+prsn.id : "";
		var service_code = ("service_code" in prsn && prsn.service_code != "")? "\n "+prsn.service_code : "";
		var tel = ("tel" in prsn && prsn.tel != "")? "\n Tel : "+prsn.tel : "";
		var societe = ("societe" in prsn && prsn.societe != "")? "\n "+prsn.societe : "";
		var role = ("role" in prsn && prsn.role != "")? "\n "+prsn.role : "";
		var emplacement = ("emplacement" in prsn && prsn.emplacement != "")? "\n Emplacement : "+prsn.emplacement : "";
		var ville = ("ville" in prsn && prsn.ville != "")? "\n "+prsn.ville : "";
		var tooltip = civilite + ageStr + anciennete + categorie_pro + id + service_code + tel + societe + role + emplacement;
		
		// Données de l'encadré
		var service = ("service" in prsn && prsn.service != "")? "\n "+prsn.service : "";
		var site = ("service" in prsn && prsn.site != "")? "\n "+prsn.site : "";
		var serviceStr, siteStr;
		if(service!=""){serviceStr=service;}else if(service_code!=""){serviceStr=service_code;}
		if(site!=""){siteStr=site;}else if(ville!=""){siteStr=ville;}else if(societe!=""){siteStr=societe;}
		display = 
			"<strong>"+prsn.nom+"<br/>"
			+prsn.prenom+"</strong>"
			+"<p class=\"service\">"+serviceStr+"</p>"
			+"<p class=\"site\">"+siteStr+"</p>";
			
		liChild.innerHTML+= display;
		liChild.innerHTML+= (tooltip != "")? '<p class="infos"  data-tooltip data-tooltip-message="'+tooltip+'"> + </p>' : '';
		liChild.dataset.name = formComp;
		return liChild;
	}
	
	// Fast function to remove accent to compare strings
	function formatCompare(inStr) {
		return inStr.replace(/([àáâãäå])|([ç])|([èéêë])|([ìíîï])|([ñ])|([òóôõöø])|([ß])|([ùúûü])|([ÿ])|([æ])|([-'])/g, function(str,a,c,e,i,n,o,s,u,y,ae,tiret) { if(a) return 'a'; else if(c) return 'c'; else if(e) return 'e'; else if(i) return 'i'; else if(n) return 'n'; else if(o) return 'o'; else if(s) return 's'; else if(u) return 'u'; else if(y) return 'y'; else if(ae) return 'ae'; else if(tiret) return ' '; }).toLowerCase();
	}
	</script>
	
	
    <script>
        jQuery(document).ready(function() {
            
            /* Custom jQuery for the example */
            $("#show-list").click(function(e){
                e.preventDefault();
                
                $('#list-html').toggle('fast', function(){
                    if($(this).is(':visible')){
                        $('#show-list').text('Hide underlying list.');
                        $(".topbar").fadeTo('fast',0.9);
                    }else{
                        $('#show-list').text('Show underlying list.');
                        $(".topbar").fadeTo('fast',1);                  
                    }
                });
            });
            
            $('#list-html').text($('#org').html());
            
            $("#org").bind("DOMSubtreeModified", function() {
                $('#list-html').text('');
                
                $('#list-html').text($('#org').html());
                
                prettyPrint();                
            });
        });
    </script>
	<br/>
	<br/>
	<br/>
</body>
</html>